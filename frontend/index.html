<!DOCTYPE html>
<html lang="sl" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dnevni ≈°olski jedilnik - O≈† Trbovlje</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#FF6B6B">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="≈†olski Jedilnik">
    <link rel="apple-touch-icon" href="school-logo.png">
    <link rel="icon" type="image/png" href="school-logo.png">
    
    <!-- Tailwind CSS with DaisyUI -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.10/dist/full.min.css" rel="stylesheet" type="text/css" />
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'tomato': '#FF6B6B',
                        'carrot': '#FF9F43',
                        'salad': '#7ED321',
                        'sky': '#74B9FF',
                        'apple': '#FF4757',
                        'leaf': '#2ED573'
                    }
                }
            }
        }
    </script>
    
    <style>
        /* Meal card hover effects */
        .meal-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        /* Enhanced tooltip behavior for touch devices */
        .allergen-badge {
            cursor: pointer;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        .allergen-badge:active {
            transform: scale(0.95);
        }
        
        /* Force tooltip visibility when tooltip-open class is added */
        .tooltip.tooltip-open:before,
        .tooltip.tooltip-open:after {
            opacity: 1 !important;
            visibility: visible !important;
        }
        
        /* Improve tooltip positioning on mobile */
        @media (max-width: 768px) {
            .tooltip:before {
                font-size: 0.75rem;
                padding: 4px 8px;
                white-space: nowrap;
                max-width: 200px;
                word-wrap: break-word;
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-orange-100 via-yellow-50 to-green-100 min-h-screen relative overflow-x-hidden">
    

    <!-- Main Content -->
    <div class="container mx-auto max-w-2xl p-4 content-wrapper">
        
        <!-- Fun Header -->
        <div class="text-center mb-8 py-8">
            <h1 class="text-5xl md:text-6xl font-black text-tomato mb-4">
                Jedilnik O≈† Trbovlje
            </h1>
            <div class="text-lg text-gray-600 mt-2">
                <span id="currentDay"><!-- Current day will be inserted here --></span> ‚Ä¢ 
                <a href="#" id="menuLink" class="text-blue-600 hover:text-blue-800 hover:underline transition-colors duration-200" target="_blank" rel="noopener noreferrer">
                    <span id="menuDateRange">Nalagam jedilnik...</span>
                </a>
            </div>
        </div>
        
        <!-- Main Card Container -->
        <div class="card bg-white shadow-2xl rounded-2xl overflow-hidden border-4 border-yellow-200">
            <div class="card-body p-8">
                
                
                <!-- Loading State -->
                <div class="text-center py-12 hidden" id="loading">
                    <div class="loading loading-spinner loading-lg text-accent mb-4"></div>
                    <p class="text-xl font-semibold text-gray-600">Pridobivam okusne novice...</p>
                </div>
                
                <!-- Menu Sections -->
                <div id="menuContent" class="space-y-8">
                    <!-- Dynamic menu content will be loaded here -->
                </div>
                    
                    <!-- Allergen Info -->
                    <div class="alert alert-info shadow-lg bg-blue-50 border-blue-300">
                        <div class="flex-col items-start w-full">
                            <h3 class="font-bold text-lg text-blue-800">Kaj pomenijo ƒçrke? To so alergeni. Vpra≈°aj uƒçitelja/co ƒçe te zanima veƒç.</h3>
                        </div>
            </div>
            
                    <!-- Developer Credits -->
                    <div class="card bg-gray-50 shadow-lg border border-gray-200">
                        <div class="card-body text-center py-6">
                            <h3 class="text-lg font-bold text-gray-800 mb-2">üíª Aplikacijo je ustvaril</h3>
                            <p class="text-xl font-semibold text-gray-700 mb-1">Andra≈æ Jev≈°evar</p>
                            <p class="text-sm text-gray-600 mb-4">Razred: 4.b</p>
                            <button 
                                class="btn btn-sm btn-outline btn-primary"
                                onclick="window.location.href='mailto:andraz.jevsevar@ostrbovlje.si?subject=Povratne informacije - ≈†olski jedilnik&body=Pozdravljen,%0A%0APi≈°em vam glede aplikacije za ≈°olski jedilnik...%0A%0ALep pozdrav'"
                            >
                                üìß Po≈°lji povratne informacije
            </button>
                        </div>
                    </div>
            
            </div>
            
                <!-- Success Toast (Hidden by default) -->
                <div class="toast toast-top toast-center hidden" id="successToast">
                    <div class="alert alert-success shadow-lg">
                        <div>
                            <span class="text-lg">‚úÖ</span>
                            <span class="font-semibold">Jedilnik uspe≈°no osve≈æen!</span>
                        </div>
                    </div>
            </div>
            
            </div>
        </div>
        
        <!-- Footer -->
        <div class="text-center mt-8 text-gray-500 text-sm">
            <div>Zadnja posodobitev: <span class="font-medium" id="lastUpdate"></span></div>
            <div class="mt-2">
                <button class="btn btn-ghost btn-xs text-gray-400 hover:text-gray-600 transition-colors duration-200" id="refreshBtn">
                    üîÑ Osve≈æi
                </button>
            </div>
        </div>
        
    </div>

    <script>
        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js')
                .then((registration) => console.log('ServiceWorker registered'))
                .catch((error) => console.log('ServiceWorker registration failed:', error));
        }

        // Initialize current date in Slovenian
        function updateCurrentDay() {
            const now = new Date();

        // Slovenian day names
            const slovenianDays = [
                'Nedelja', 'Ponedeljek', 'Torek', 'Sreda', 'ƒåetrtek', 'Petek', 'Sobota'
            ];
            
            const dayName = slovenianDays[now.getDay()];
            const day = now.getDate().toString().padStart(2, '0');
            const month = (now.getMonth() + 1).toString().padStart(2, '0');
            const year = now.getFullYear();
            
            const dateText = `${dayName}, ${day}.${month}.${year}`;
            document.getElementById('currentDay').textContent = dateText;
        }

        // Allergen translations
        const allergenTranslations = {
            'G': 'Gluten',
            'J': 'Jajce',
            'S': 'Soja',
            'L': 'Laktoza',
            'GS': 'Gorƒçiƒçno seme',
            'R': 'Ribe',
            'O': 'Ore≈°ƒçki',
            'SE': 'Sezam',
            'Z': 'Zelena',
            '≈ΩD': '≈Ωveplov dioksid',
            'RA': 'Raki',
            'M': 'Mehku≈æci',
            'V': 'Volƒçji bob'
        };

        // Simple display of menu data
        function displayMenu(menuData) {
            const menuContent = document.getElementById('menuContent');
            const menuText = menuData.menu;
            
            // Check if this is an error message
            if (menuText.startsWith('‚ùå') || menuText.includes('Ne morem najti') || menuText.includes('Napaka')) {
                menuContent.innerHTML = `
                    <div class="alert alert-error shadow-lg">
                        <div>
                            <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current flex-shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                            <div>
                                <h3 class="font-bold">Jedilnik ni na voljo</h3>
                                <div class="text-sm">${menuText}</div>
                            </div>
                        </div>
                    </div>
                `;
                return;
            }
            
            // Split menu into lines and format nicely
            const lines = menuText.split('\n');
            let html = '';
            
            for (let line of lines) {
                line = line.trim();
                if (!line) continue;
                
                if (line.includes('üçΩÔ∏è')) {
                    // Skip the main title line
                    continue;
                } else if (line.includes('üìã Jedilnik:')) {
                    // Skip the subtitle line
                    continue;
                } else if (line.match(/^[A-Z]{3}, \d{1,2}\.\d{1,2}$/)) {
                    // Skip the date line (e.g., "PET, 26.09")
                    continue;
                } else if (line.includes('ü•ó MALICA:')) {
                    // MALICA section
                    const items = line.split('ü•ó MALICA:')[1].trim();
                    html += createSimpleMealSection('ü•ó MALICA', items, 'green', 'salad');
                } else if (line.includes('üçù KOSILO:')) {
                    // KOSILO section
                    const items = line.split('üçù KOSILO:')[1].trim();
                    html += createSimpleMealSection('üçù KOSILO', items, 'red', 'tomato');
                } else if (line.includes('üçé POP. MALICA:')) {
                    // POP. MALICA section
                    const items = line.split('üçé POP. MALICA:')[1].trim();
                    html += createSimpleMealSection('üçé POP. MALICA', items, 'orange', 'carrot');
                } else if (line.includes('üìã ALERGENI:')) {
                    // Skip allergen section - we have our own
                    break;
                }
            }
            
            menuContent.innerHTML = html;
            
            // Re-initialize tooltip functionality after content is loaded
            setTimeout(() => {
                setupAllergenTooltips();
            }, 100);
        }
        
        function createSimpleMealSection(title, itemsText, colorScheme, borderColor) {
            // BULLETPROOF PARSING: Split by pipe separator (|) which doesn't conflict with allergens
            // Backend uses | to separate food items, while allergens within items use commas
            const items = itemsText.split('|').map(item => item.trim()).filter(item => item.length > 0);
            
            // Known allergen codes for validation
            const knownAllergens = ['G', 'J', 'S', 'L', 'GS', 'R', 'O', 'SE', 'Z', '≈ΩD', 'RA', 'M', 'V'];
            
            // Create HTML for items
            let itemsHtml = '';
            for (let item of items) {
                // Extract food name and allergens
                let foodName = item;
                let allergenCodes = [];
                
                // Look for pattern: "food name‚Äìallergen codes"
                const allergenMatch = item.match(/^(.+?)‚Äì(.+)$/);
                if (allergenMatch) {
                    foodName = allergenMatch[1].trim();
                    // Parse allergen codes - they might be separated by commas or spaces
                    const allergenPart = allergenMatch[2];
                    allergenCodes = allergenPart
                        .split(/[,\s]+/)
                        .map(code => code.trim())
                        .filter(code => {
                            // Must be 1-3 uppercase letters and be a known allergen
                            return code && /^[A-Z≈Ω≈†ƒå]{1,3}$/.test(code) && knownAllergens.includes(code);
                        });
                }
                
                // Skip items with no meaningful food name (just whitespace or too short)
                if (!foodName || foodName.length < 2) {
                    continue;
                }
                
                let allergensHtml = '';
                if (allergenCodes.length > 0) {
                    allergensHtml = `<div class="flex gap-1">
                        ${allergenCodes.map(allergen => 
                            `<div class="badge badge-warning badge-sm tooltip allergen-badge transition-all duration-300" data-tip="${allergenTranslations[allergen] || allergen}">${allergen}</div>`
                        ).join('')}
                    </div>`;
                } else {
                    allergensHtml = `<div class="badge badge-success badge-sm bg-green-100 text-green-800 border-green-300">Brez alergenov</div>`;
                }
                
                itemsHtml += `
                    <div class="flex justify-between items-center py-2 border-b border-${colorScheme}-200 last:border-b-0">
                        <span class="font-semibold text-gray-800">${foodName}</span>
                        ${allergensHtml}
                    </div>
                `;
            }
            
            return `
                <div class="card bg-${colorScheme}-50 shadow-lg hover:shadow-xl transition-all duration-300 meal-card border-l-4 border-${borderColor}">
                    <div class="card-body">
                        <h2 class="card-title text-2xl font-black text-${borderColor} mb-4 uppercase">
                            ${title}
                        </h2>
                        <div class="space-y-3">
                            ${itemsHtml}
                        </div>
                        </div>
                    </div>
                `;
            }
            
        // Fetch menu data and extract date range + URL
        async function fetchMenuInfo() {
            try {
                const response = await fetch('/api/menu');
                const data = await response.json();
                
                if (data.success && data.menu) {
                    // Update date range display
                    if (data.date_range) {
                        document.getElementById('menuDateRange').textContent = `Jedilnik ${data.date_range}`;
                    } else if (data.menu_title) {
                        const dateRangeMatch = data.menu_title.match(/(\d{1,2}\.\s*\d{1,2}\.\s*‚Äì\s*\d{1,2}\.\s*\d{1,2}\.\s*\d{4})/);
                        if (dateRangeMatch) {
                            document.getElementById('menuDateRange').textContent = `Jedilnik ${dateRangeMatch[1]}`;
                        } else {
                            document.getElementById('menuDateRange').textContent = data.menu_title;
                        }
                    }
                    
                    // Update menu URL
                    const menuUrl = data.source_url || 'https://ostrbovlje.si/prehrana/';
                    document.getElementById('menuLink').href = menuUrl;
                    
                    // Display the menu content
                    displayMenu(data);
                } else {
                    document.getElementById('menuDateRange').textContent = 'Jedilnik ni na voljo';
                    document.getElementById('menuLink').href = 'https://ostrbovlje.si/prehrana/';
                    document.getElementById('menuContent').innerHTML = '<div class="text-center text-gray-500">Jedilnik trenutno ni na voljo.</div>';
                }
            } catch (error) {
                console.error('Error fetching menu info:', error);
                document.getElementById('menuDateRange').textContent = 'Jedilnik (kliknite za ogled)';
                document.getElementById('menuLink').href = 'https://ostrbovlje.si/prehrana/';
                document.getElementById('menuContent').innerHTML = '<div class="text-center text-red-500">Napaka pri nalaganju jedilnika.</div>';
            }
        }

        // Initialize last update time
        function updateTimestamp() {
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString('sl-SI', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }
        
        updateCurrentDay();
        fetchMenuInfo();
        updateTimestamp();

        // Enhanced touch support for allergen tooltips
        function setupAllergenTooltips() {
            const allergenBadges = document.querySelectorAll('.allergen-badge');
            
            allergenBadges.forEach(badge => {
                // Add touch event for mobile devices
                badge.addEventListener('touchstart', function(e) {
                    e.preventDefault(); // Prevent default touch behavior
                    
                    // Hide all other tooltips first
                    document.querySelectorAll('.allergen-badge').forEach(otherBadge => {
                        if (otherBadge !== badge) {
                            otherBadge.classList.remove('tooltip-open');
                        }
                    });
                    
                    // Toggle this tooltip
                    badge.classList.toggle('tooltip-open');
                    
                    // Auto-hide after 3 seconds on mobile
                    setTimeout(() => {
                        badge.classList.remove('tooltip-open');
                    }, 3000);
                });
                
                // Add click event as fallback
                badge.addEventListener('click', function(e) {
                    e.stopPropagation();
                    
                    // Hide all other tooltips first
                    document.querySelectorAll('.allergen-badge').forEach(otherBadge => {
                        if (otherBadge !== badge) {
                            otherBadge.classList.remove('tooltip-open');
                        }
                    });
                    
                    // Toggle this tooltip
                    badge.classList.toggle('tooltip-open');
                    
                    // Auto-hide after 3 seconds
                    setTimeout(() => {
                        badge.classList.remove('tooltip-open');
                    }, 3000);
                });
            });
            
            // Hide tooltips when touching outside
            document.addEventListener('touchstart', function(e) {
                if (!e.target.classList.contains('allergen-badge')) {
                    document.querySelectorAll('.allergen-badge').forEach(badge => {
                        badge.classList.remove('tooltip-open');
                    });
                }
            });
            
            // Hide tooltips when clicking outside
            document.addEventListener('click', function(e) {
                if (!e.target.classList.contains('allergen-badge')) {
                    document.querySelectorAll('.allergen-badge').forEach(badge => {
                        badge.classList.remove('tooltip-open');
                    });
                }
            });
        }

        // Initialize tooltip functionality
        setupAllergenTooltips();

        // Refresh button functionality
        document.getElementById('refreshBtn').addEventListener('click', async () => {
            const loading = document.getElementById('loading');
            const menuContent = document.getElementById('menuContent');
            const refreshBtn = document.getElementById('refreshBtn');
            const successToast = document.getElementById('successToast');
            
            // Show loading state
            loading.classList.remove('hidden');
            menuContent.classList.add('opacity-30');
            refreshBtn.disabled = true;
            refreshBtn.innerHTML = '‚è≥';
            
            // Fetch fresh menu data
            try {
                await fetchMenuInfo();
                
                // Simulate some loading time for better UX
                setTimeout(() => {
                    // Hide loading state
                    loading.classList.add('hidden');
                    menuContent.classList.remove('opacity-30');
                    refreshBtn.disabled = false;
                    refreshBtn.innerHTML = 'Posodobi';
                    
                    // Update timestamp
                    updateTimestamp();
                    
                    // Show success toast
                    successToast.classList.remove('hidden');
                    setTimeout(() => {
                        successToast.classList.add('hidden');
                    }, 3000);
                    
                }, 1000);
            } catch (error) {
                console.error('Error refreshing menu:', error);
                // Hide loading state even on error
                loading.classList.add('hidden');
                menuContent.classList.remove('opacity-30');
                refreshBtn.disabled = false;
                refreshBtn.innerHTML = 'üîÑ Osve≈æi jedilnik';
            }
        });

    </script>
</body>
</html>
