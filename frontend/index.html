<!DOCTYPE html>
<html lang="sl" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dnevni ≈°olski jedilnik - O≈† Trbovlje</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#FF6B6B">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="≈†olski Jedilnik">
    <link rel="apple-touch-icon" href="school-logo.png">
    <link rel="icon" type="image/png" href="school-logo.png">
    
    <!-- Tailwind CSS with DaisyUI -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.10/dist/full.min.css" rel="stylesheet" type="text/css" />
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'tomato': '#FF6B6B',
                        'carrot': '#FF9F43',
                        'salad': '#7ED321',
                        'sky': '#74B9FF',
                        'apple': '#FF4757',
                        'leaf': '#2ED573'
                    }
                }
            }
        }
    </script>
    
    <style>
        /* Meal card hover effects */
        .meal-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        /* Enhanced tooltip behavior for touch devices */
        .allergen-badge {
            cursor: pointer;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        .allergen-badge:active {
            transform: scale(0.95);
        }
        
        /* Force tooltip visibility when tooltip-open class is added */
        .tooltip.tooltip-open:before,
        .tooltip.tooltip-open:after {
            opacity: 1 !important;
            visibility: visible !important;
        }
        
        /* Improve tooltip positioning on mobile */
        @media (max-width: 768px) {
            .tooltip:before {
                font-size: 0.75rem;
                padding: 4px 8px;
                white-space: nowrap;
                max-width: 200px;
                word-wrap: break-word;
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-orange-100 via-yellow-50 to-green-100 min-h-screen relative overflow-x-hidden">
    

    <!-- Main Content -->
    <div class="container mx-auto max-w-2xl p-4 content-wrapper">
        
        <!-- Fun Header -->
        <div class="text-center mb-8 py-8">
            <h1 class="text-5xl md:text-6xl font-black text-tomato mb-4">
                Jedilnik O≈† Trbovlje
            </h1>
            <div class="text-lg text-gray-600 mt-2">
                <span id="currentDay"><!-- Current day will be inserted here --></span> ‚Ä¢ 
                <a href="#" id="menuLink" class="text-blue-600 hover:text-blue-800 hover:underline transition-colors duration-200" target="_blank" rel="noopener noreferrer">
                    <span id="menuDateRange">Nalagam jedilnik...</span>
                </a>
            </div>
        </div>
        
        <!-- Main Card Container -->
        <div class="card bg-white shadow-2xl rounded-2xl overflow-hidden border-4 border-yellow-200">
            <div class="card-body p-8">
                
                
                <!-- Loading State -->
                <div class="text-center py-12 hidden" id="loading">
                    <div class="loading loading-spinner loading-lg text-accent mb-4"></div>
                    <p class="text-xl font-semibold text-gray-600">Pridobivam okusne novice...</p>
                </div>
                
                <!-- Menu Sections -->
                <div id="menuContent" class="space-y-8">
                    
                    <!-- MALICA Section -->
                    <div class="card bg-green-50 shadow-lg hover:shadow-xl transition-all duration-300 meal-card border-l-4 border-salad">
                        <div class="card-body">
                            <h2 class="card-title text-2xl font-black text-salad mb-4 uppercase">
                                ü•ó MALICA
                            </h2>
                            <div class="space-y-3">
                                <div class="flex justify-between items-center py-2 border-b border-green-200 last:border-b-0">
                                    <span class="font-semibold text-gray-800">Temna borovniƒçeva palƒçka</span>
                                    <div class="flex gap-1">
                                        <div class="badge badge-warning badge-sm tooltip allergen-badge transition-all duration-300" data-tip="Gluten">G</div>
                                        <div class="badge badge-warning badge-sm tooltip allergen-badge transition-all duration-300" data-tip="Laktoza">L</div>
                                        <div class="badge badge-warning badge-sm tooltip allergen-badge transition-all duration-300" data-tip="Jajce">J</div>
                                        <div class="badge badge-warning badge-sm tooltip allergen-badge transition-all duration-300" data-tip="Soja">S</div>
                                    </div>
                                </div>
                                <div class="flex justify-between items-center py-2 border-b border-green-200 last:border-b-0">
                                    <span class="font-semibold text-gray-800">Sok brez dodanega sladkorja</span>
                                    <div class="badge badge-success badge-sm bg-green-100 text-green-800 border-green-300">Brez alergenov</div>
                                </div>
                                <div class="flex justify-between items-center py-2 border-b border-green-200 last:border-b-0">
                                    <span class="font-semibold text-gray-800">≈†S‚àíbreskev</span>
                                    <div class="badge badge-success badge-sm bg-green-100 text-green-800 border-green-300">Brez alergenov</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- KOSILO Section -->
                    <div class="card bg-red-50 shadow-lg hover:shadow-xl transition-all duration-300 meal-card border-l-4 border-tomato">
                        <div class="card-body">
                            <h2 class="card-title text-2xl font-black text-tomato mb-4 uppercase">
                                üçù KOSILO
                            </h2>
                            <div class="space-y-3">
                                <div class="flex justify-between items-center py-2 border-b border-red-200 last:border-b-0">
                                    <span class="font-semibold text-gray-800">Mesni ha≈°e</span>
                                    <div class="flex gap-1">
                                        <div class="badge badge-warning badge-sm tooltip allergen-badge transition-all duration-300" data-tip="Gluten">G</div>
                                    </div>
                                </div>
                                <div class="flex justify-between items-center py-2 border-b border-red-200 last:border-b-0">
                                    <span class="font-semibold text-gray-800">Sirovi ravioli</span>
                                    <div class="flex gap-1">
                                        <div class="badge badge-warning badge-sm tooltip allergen-badge transition-all duration-300" data-tip="Gluten">G</div>
                                        <div class="badge badge-warning badge-sm tooltip allergen-badge transition-all duration-300" data-tip="Laktoza">L</div>
                                        <div class="badge badge-warning badge-sm tooltip allergen-badge transition-all duration-300" data-tip="Jajce">J</div>
                                        <div class="badge badge-warning badge-sm tooltip allergen-badge transition-all duration-300" data-tip="Soja">S</div>
                                        <div class="badge badge-warning badge-sm tooltip allergen-badge transition-all duration-300" data-tip="≈Ωveplov dioksid">≈ΩD</div>
                                    </div>
                                </div>
                                <div class="flex justify-between items-center py-2 border-b border-red-200 last:border-b-0">
                                    <span class="font-semibold text-gray-800">Zelena solata s fi≈æolom in paradi≈ænikom</span>
                                    <div class="badge badge-success badge-sm bg-green-100 text-green-800 border-green-300">Brez alergenov</div>
                                </div>
                                <div class="flex justify-between items-center py-2 border-b border-red-200 last:border-b-0">
                                    <span class="font-semibold text-gray-800">Sadje</span>
                                    <div class="badge badge-success badge-sm bg-green-100 text-green-800 border-green-300">Brez alergenov</div>
                                </div>
                                <div class="flex justify-between items-center py-2 border-b border-red-200 last:border-b-0">
                                    <span class="font-semibold text-gray-800">Sirup brez dodanega sladkorja</span>
                                    <div class="badge badge-success badge-sm bg-green-100 text-green-800 border-green-300">Brez alergenov</div>
                                </div>
                                <div class="flex justify-between items-center py-2 border-b border-red-200 last:border-b-0">
                                    <span class="font-semibold text-gray-800">R≈æen kruh</span>
                                    <div class="flex gap-1">
                                        <div class="badge badge-warning badge-sm tooltip allergen-badge transition-all duration-300" data-tip="Gluten">G</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- POP. MALICA Section -->
                    <div class="card bg-orange-50 shadow-lg hover:shadow-xl transition-all duration-300 meal-card border-l-4 border-carrot">
                        <div class="card-body">
                            <h2 class="card-title text-2xl font-black text-apple mb-4 uppercase">
                                üçé POP. MALICA
                            </h2>
                            <div class="space-y-3">
                                <div class="flex justify-between items-center py-2 border-b border-orange-200 last:border-b-0">
                                    <span class="font-semibold text-gray-800">R≈æen kruh</span>
                                    <div class="flex gap-1">
                                        <div class="badge badge-warning badge-sm tooltip allergen-badge transition-all duration-300" data-tip="Gluten">G</div>
                                    </div>
                                </div>
                                <div class="flex justify-between items-center py-2 border-b border-orange-200 last:border-b-0">
                                    <span class="font-semibold text-gray-800">Pi≈°ƒçanƒçja salama</span>
                                    <div class="badge badge-success badge-sm bg-green-100 text-green-800 border-green-300">Brez alergenov</div>
                                </div>
                                <div class="flex justify-between items-center py-2 border-b border-orange-200 last:border-b-0">
                                    <span class="font-semibold text-gray-800">Paradi≈ænik</span>
                                    <div class="badge badge-success badge-sm bg-green-100 text-green-800 border-green-300">Brez alergenov</div>
                                </div>
                                <div class="flex justify-between items-center py-2 border-b border-orange-200 last:border-b-0">
                                    <span class="font-semibold text-gray-800">Voda</span>
                                    <div class="badge badge-success badge-sm bg-green-100 text-green-800 border-green-300">Brez alergenov</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Allergen Info -->
                    <div class="alert alert-info shadow-lg bg-blue-50 border-blue-300">
                        <div class="flex-col items-start w-full">
                            <h3 class="font-bold text-lg text-blue-800">Kaj pomenijo ƒçrke? To so alergeni. Vpra≈°aj uƒçitelja/co ƒçe te zanima veƒç.</h3>
                        </div>
            </div>
            
                    <!-- Developer Credits -->
                    <div class="card bg-gray-50 shadow-lg border border-gray-200">
                        <div class="card-body text-center py-6">
                            <h3 class="text-lg font-bold text-gray-800 mb-2">üíª Aplikacijo je ustvaril</h3>
                            <p class="text-xl font-semibold text-gray-700 mb-1">Andra≈æ Jev≈°evar</p>
                            <p class="text-sm text-gray-600 mb-4">Razred: 4.b</p>
                            <button 
                                class="btn btn-sm btn-outline btn-primary"
                                onclick="window.location.href='mailto:andraz.jevsevar@ostrbovlje.si?subject=Povratne informacije - ≈†olski jedilnik&body=Pozdravljen,%0A%0APi≈°em vam glede aplikacije za ≈°olski jedilnik...%0A%0ALep pozdrav'"
                            >
                                üìß Po≈°lji povratne informacije
            </button>
                        </div>
                    </div>
            
            </div>
            
                <!-- Success Toast (Hidden by default) -->
                <div class="toast toast-top toast-center hidden" id="successToast">
                    <div class="alert alert-success shadow-lg">
                        <div>
                            <span class="text-lg">‚úÖ</span>
                            <span class="font-semibold">Jedilnik uspe≈°no osve≈æen!</span>
                        </div>
                    </div>
            </div>
            
            </div>
        </div>
        
        <!-- Footer -->
        <div class="text-center mt-8 text-gray-500 text-sm">
            <div>Zadnja posodobitev: <span class="font-medium" id="lastUpdate"></span></div>
            <div class="mt-2">
                <button class="btn btn-ghost btn-xs text-gray-400 hover:text-gray-600 transition-colors duration-200" id="refreshBtn">
                    üîÑ Osve≈æi
                </button>
            </div>
        </div>
        
    </div>

    <script>
        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js')
                .then((registration) => console.log('ServiceWorker registered'))
                .catch((error) => console.log('ServiceWorker registration failed:', error));
        }

        // Initialize current date in Slovenian
        function updateCurrentDay() {
            const now = new Date();

        // Slovenian day names
            const slovenianDays = [
                'Nedelja', 'Ponedeljek', 'Torek', 'Sreda', 'ƒåetrtek', 'Petek', 'Sobota'
            ];
            
            const dayName = slovenianDays[now.getDay()];
            const day = now.getDate().toString().padStart(2, '0');
            const month = (now.getMonth() + 1).toString().padStart(2, '0');
            const year = now.getFullYear();
            
            const dateText = `${dayName}, ${day}.${month}.${year}`;
            document.getElementById('currentDay').textContent = dateText;
        }

        // Fetch menu data and extract date range + URL
        async function fetchMenuInfo() {
            try {
                const response = await fetch('/api/menu');
                const data = await response.json();
                
                if (data.success && data.menu) {
                    // Use date range from API response if available
                    if (data.date_range) {
                        document.getElementById('menuDateRange').textContent = `Jedilnik ${data.date_range}`;
                    } else if (data.menu_title) {
                        // Extract date range from menu title
                        const dateRangeMatch = data.menu_title.match(/(\d{1,2}\.\s*\d{1,2}\.\s*‚Äì\s*\d{1,2}\.\s*\d{1,2}\.\s*\d{4})/);
                        if (dateRangeMatch) {
                            document.getElementById('menuDateRange').textContent = `Jedilnik ${dateRangeMatch[1]}`;
                        } else {
                            document.getElementById('menuDateRange').textContent = data.menu_title;
                        }
                    } else {
                        // Fallback: try to extract from menu content
                        const menuText = data.menu;
                        const dateRangeMatch = menuText.match(/Jedilnik\s+(\d{1,2}\.\s*\d{1,2}\.\s*‚Äì\s*\d{1,2}\.\s*\d{1,2}\.\s*\d{4})/i);
                        if (dateRangeMatch) {
                            document.getElementById('menuDateRange').textContent = `Jedilnik ${dateRangeMatch[1]}`;
                        } else {
                            document.getElementById('menuDateRange').textContent = 'Jedilnik';
                        }
                    }
                    
                    // Use the source URL from API response
                    const menuUrl = data.source_url || 'https://ostrbovlje.si/prehrana/';
                    document.getElementById('menuLink').href = menuUrl;
                    
                    console.log('Menu URL set to:', menuUrl);
                } else {
                    document.getElementById('menuDateRange').textContent = 'Jedilnik ni na voljo';
                    document.getElementById('menuLink').href = 'https://ostrbovlje.si/prehrana/';
                }
            } catch (error) {
                console.error('Error fetching menu info:', error);
                document.getElementById('menuDateRange').textContent = 'Jedilnik (kliknite za ogled)';
                document.getElementById('menuLink').href = 'https://ostrbovlje.si/prehrana/';
            }
        }

        // Initialize last update time
        function updateTimestamp() {
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString('sl-SI', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }
        
        updateCurrentDay();
        fetchMenuInfo();
        updateTimestamp();

        // Enhanced touch support for allergen tooltips
        function setupAllergenTooltips() {
            const allergenBadges = document.querySelectorAll('.allergen-badge');
            
            allergenBadges.forEach(badge => {
                // Add touch event for mobile devices
                badge.addEventListener('touchstart', function(e) {
                    e.preventDefault(); // Prevent default touch behavior
                    
                    // Hide all other tooltips first
                    document.querySelectorAll('.allergen-badge').forEach(otherBadge => {
                        if (otherBadge !== badge) {
                            otherBadge.classList.remove('tooltip-open');
                        }
                    });
                    
                    // Toggle this tooltip
                    badge.classList.toggle('tooltip-open');
                    
                    // Auto-hide after 3 seconds on mobile
                    setTimeout(() => {
                        badge.classList.remove('tooltip-open');
                    }, 3000);
                });
                
                // Add click event as fallback
                badge.addEventListener('click', function(e) {
                    e.stopPropagation();
                    
                    // Hide all other tooltips first
                    document.querySelectorAll('.allergen-badge').forEach(otherBadge => {
                        if (otherBadge !== badge) {
                            otherBadge.classList.remove('tooltip-open');
                        }
                    });
                    
                    // Toggle this tooltip
                    badge.classList.toggle('tooltip-open');
                    
                    // Auto-hide after 3 seconds
                    setTimeout(() => {
                        badge.classList.remove('tooltip-open');
                    }, 3000);
                });
            });
            
            // Hide tooltips when touching outside
            document.addEventListener('touchstart', function(e) {
                if (!e.target.classList.contains('allergen-badge')) {
                    document.querySelectorAll('.allergen-badge').forEach(badge => {
                        badge.classList.remove('tooltip-open');
                    });
                }
            });
            
            // Hide tooltips when clicking outside
            document.addEventListener('click', function(e) {
                if (!e.target.classList.contains('allergen-badge')) {
                    document.querySelectorAll('.allergen-badge').forEach(badge => {
                        badge.classList.remove('tooltip-open');
                    });
                }
            });
        }

        // Initialize tooltip functionality
        setupAllergenTooltips();

        // Refresh button functionality
        document.getElementById('refreshBtn').addEventListener('click', async () => {
            const loading = document.getElementById('loading');
            const menuContent = document.getElementById('menuContent');
            const refreshBtn = document.getElementById('refreshBtn');
            const successToast = document.getElementById('successToast');
            
            // Show loading state
            loading.classList.remove('hidden');
            menuContent.classList.add('opacity-30');
            refreshBtn.disabled = true;
            refreshBtn.innerHTML = '‚è≥';
            
            // Fetch fresh menu data
            try {
                await fetchMenuInfo();
                
                // Simulate some loading time for better UX
                setTimeout(() => {
                    // Hide loading state
                    loading.classList.add('hidden');
                    menuContent.classList.remove('opacity-30');
                    refreshBtn.disabled = false;
                    refreshBtn.innerHTML = 'Posodobi';
                    
                    // Update timestamp
                    updateTimestamp();
                    
                    // Show success toast
                    successToast.classList.remove('hidden');
                    setTimeout(() => {
                        successToast.classList.add('hidden');
                    }, 3000);
                    
                }, 1000);
            } catch (error) {
                console.error('Error refreshing menu:', error);
                // Hide loading state even on error
                loading.classList.add('hidden');
                menuContent.classList.remove('opacity-30');
                refreshBtn.disabled = false;
                refreshBtn.innerHTML = 'üîÑ Osve≈æi jedilnik';
            }
        });

    </script>
</body>
</html>
